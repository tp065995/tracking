{% extends "admin/base.html" %}

{% block content %}
<div class="container-header">
    <div class="header-content">
        <h2><i class="fas fa-boxes"></i> Manage Containers</h2>
        <div class="header-stats">
            <span class="stat-item">
                <i class="fas fa-ship"></i> At Port: {{ containers|selectattr('status', 'equalto', 'Arrived')|list|length }}
            </span>
            <span class="stat-item">
                <i class="fas fa-route"></i> In Transit: {{ containers|rejectattr('status', 'equalto', 'Not Assigned')|rejectattr('status', 'equalto', 'Arrived')|rejectattr('status', 'equalto', 'En Route')|list|length }}
            </span>
        </div>
    </div>
    <button class="btn btn-primary" onclick="showAddContainerModal()">
        <i class="fas fa-plus"></i> Add Container
    </button>
</div>

<div class="search-filters">
    <div class="search-box">
        <i class="fas fa-search"></i>
        <input type="text" id="containerSearch" placeholder="Search containers...">
    </div>
    <div class="filter-group">
        <select id="statusFilter" class="form-control">
            <option value="">All Status</option>
            <option value="Not Assigned">Not Assigned</option>
            <option value="En Route">En Route</option>
            <option value="In Transit via">In Transit</option>
            <option value="Arrived">Arrived</option>
        </select>
    </div>
</div>

<div class="admin-table-wrapper">
    <table class="admin-table">
        <thead>
            <tr>
                <th>Container Number</th>
                <th>Current Port</th>  <!-- Changed from Current Location -->
                <th>Final Destination</th>
                <th>Vessel</th>
                <th>Status</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody>
            {% for container in containers %}
            <tr>
                <td>{{ container.container_number }}</td>
                <td>{{ container.vessel.current_port if container.vessel else 'Not Assigned' }}</td>
                <td>{{ container.final_destination }}</td>
                <td>{{ container.vessel.vessel_name if container.vessel else 'Not Assigned' }}</td>
                <td>{{ container.status }}</td>
                <td>
                    <button class="btn btn-small btn-primary" onclick="editContainer('{{ container.id }}')">
                        <i class="fas fa-edit"></i>
                    </button>
                    <button class="btn btn-small btn-danger" onclick="deleteContainer('{{ container.id }}')">
                        <i class="fas fa-trash"></i>
                    </button>
                </td>
            </tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<!-- Add Container Modal -->
<div id="containerModal" class="modal" style="display: none;">
    <div class="modal-content">
        <div class="modal-header">
            <h3><i class="fas fa-box"></i> Add New Container</h3>
            <button type="button" class="modal-close" onclick="closeModal()">
                <i class="fas fa-times"></i>
            </button>
        </div>
        <form id="containerForm" onsubmit="handleSubmit(event)">
            <div class="form-grid">
                <div class="form-group">
                    <label for="container_number">Container Number <span class="required">*</span></label>
                    <input type="text" id="container_number" class="form-control" required>
                </div>
                <div class="form-group">
                    <label for="vessel_id">Assign to Vessel <span class="required">*</span></label>
                    <div class="select-wrapper">
                        <select id="vessel_id" class="form-control" required>
                            <option value="">Select vessel</option>
                            {% for vessel in vessels %}
                            <option value="{{ vessel.id }}">{{ vessel.vessel_name }} ({{ vessel.voyage_number }}) - {{ vessel.destination_port }}</option>
                            {% endfor %}
                        </select>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </div>
            <div class="form-grid">
                <div class="form-group">
                    <label for="final_destination">Final Destination <span class="required">*</span></label>
                    <div class="select-wrapper">
                        <select id="final_destination" class="form-control" required>
                            <option value="">Select destination</option>
                            <option value="Mutsamudu">Mutsamudu</option>
                            <option value="Moroni">Moroni</option>
                        </select>
                        <i class="fas fa-chevron-down"></i>
                    </div>
                </div>
            </div>
            <div class="modal-actions">
                <button type="button" class="btn btn-secondary" onclick="closeModal()">
                    <i class="fas fa-times"></i> Cancel
                </button>
                <button type="submit" class="btn btn-primary">
                    <i class="fas fa-save"></i> Save Container
                </button>
            </div>
        </form>
    </div>
</div>

<script>
function showAddContainerModal() {
    document.getElementById('containerModal').style.display = 'block';
}

function closeModal() {
    document.getElementById('containerModal').style.display = 'none';
}

async function handleSubmit(event) {
    event.preventDefault();
    
    const form = event.target;
    const isEdit = form.dataset.mode === 'edit';
    const id = form.dataset.id;
    
    const data = {
        container_number: document.getElementById('container_number').value,
        final_destination: document.getElementById('final_destination').value,
        vessel_id: document.getElementById('vessel_id').value
    };

    try {
        const response = await fetch(isEdit ? `/admin/containers/${id}` : '/admin/containers/add', {
            method: isEdit ? 'PUT' : 'POST',
            headers: { 'Content-Type': 'application/json' },
            body: JSON.stringify(data)
        });

        if (response.ok) {
            closeModal();
            window.location.reload();
        } else {
            alert(`Error ${isEdit ? 'updating' : 'adding'} container`);
        }
    } catch (error) {
        console.error('Error:', error);
        alert(`Error ${isEdit ? 'updating' : 'adding'} container`);
    }
}

async function editContainer(id) {
    try {
        const response = await fetch(`/admin/containers/${id}`);
        const data = await response.json();
        
        if (response.ok) {
            // Populate modal fields
            document.getElementById('container_number').value = data.container_number;
            document.getElementById('final_destination').value = data.final_destination;
            document.getElementById('vessel_id').value = data.vessel_id || '';
            
            // Update form attributes for edit mode
            const form = document.getElementById('containerForm');
            form.dataset.mode = 'edit';
            form.dataset.id = id;
            
            // Update modal title and button text
            document.querySelector('.modal-header h3').innerHTML = '<i class="fas fa-edit"></i> Edit Container';
            document.querySelector('.modal-actions .btn-primary').innerHTML = '<i class="fas fa-save"></i> Update Container';
            
            // Show modal
            showAddContainerModal();
        }
    } catch (error) {
        console.error('Error:', error);
        alert('Error loading container data');
    }
}

// Close modal when clicking outside
window.onclick = function(event) {
    if (event.target == document.getElementById('containerModal')) {
        closeModal();
    }
}

function deleteContainer(id) {
    if (confirm('Are you sure you want to delete this container?')) {
        fetch(`/admin/containers/${id}`, { method: 'DELETE' })
            .then(response => response.json())
            .then(data => {
                if (data.message) {
                    window.location.reload();
                }
            });
    }
}

// Add search and filter functionality
document.getElementById('containerSearch').addEventListener('input', filterContainers);
document.getElementById('statusFilter').addEventListener('change', filterContainers);

function filterContainers() {
    const searchTerm = document.getElementById('containerSearch').value.toLowerCase();
    const statusFilter = document.getElementById('statusFilter').value;
    const rows = document.querySelectorAll('.admin-table tbody tr');

    rows.forEach(row => {
        const containerNumber = row.cells[0].textContent.toLowerCase();
        const status = row.cells[4].textContent;  // Status column
        const matchesSearch = containerNumber.includes(searchTerm);
        const matchesStatus = !statusFilter || 
                            (statusFilter === 'In Transit via' && status.startsWith('In Transit via')) ||
                            status === statusFilter;
        
        row.style.display = matchesSearch && matchesStatus ? '' : 'none';
    });
}
</script>
{% endblock %}
